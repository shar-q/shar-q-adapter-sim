# SHAR-Q Adapter Simulator
The SHAR-Q Adapter Simulator enable to simulate simple read property request in SHAR-Q Environment.

The SHAR-Q Adapter Simulator is used to provide example for authenticated encryption used for end-to-end encryption between SHAR-Q Added-value service and SHAR-Q Smart Energy Components.

The authenticated encryption is implemented by applying Javascript Web Encryption (JWE) and Javascript Web Signiture (JWS) from JOSE Standard.

## Javascript Web Signing
The public key used during verification of message signiture is used as external identity of the devices or service participating in communication.

The validity of the public key can be used to verify validity of device/service identity.

The public key is used as basis for the non-repudiation of peers (devices/ service) behaviour in P2P network.

The private key should be kept private by device or service. Note, for the simplicity of implementation this adapter simulator kept public and private keys of all simulated devices and services.

## Javascript Web Encryption
The content of the communication between peers can be encrypted by the public key of the communication destination peer (device or service).

## END-TO-END encryption
To satisfy end-to-end encryption the both technics needs to be applied, JWS and JWE.

This will be demonstrated in the simple example of to device communicating through one SHAR-Q Gateway API (for sake of simple configuration) by signing and encrypting of the simple property response.

The example is using public and private keys generated by the open-ssl. Thus external validation of the public keys is not part of the example. However it can be easily implemented by peers (services or devices). 

# Install
The following steps needs to be done to install SHAR-Q adapter simulator.

## Clone the repository
```
  git clone git@github.com:shar-q/shar-q-adapter-sim.git
  ```

## Install node
Follow your operating system recommendations how to install NODEJS.

## Install package
```
cd shar-q-adapter-sim
npm install
```

## Install SHAR-Q Gateway API
Follow the SHAR-Q Gateway API installation and configuration.

# Configure
The configuration of the device is done through the ```config/config.js```. In the config you can setup:

 * connection to VICINITY Gateway API by ```config.gateway``` object;
 * setup your adapter simulator by ```config.adapter``` object.
 * service configuration;

Note, that adapter simulator support one device and one service simulation. Key pairs are not related to any specific device and service - you can use as you want to.

## Connection to VICINITY Gateway API
The connection to VICINITY Gateway API is defined by the properties:
 * host: GWAPI running host;
 * port: GWAPI running port;
 * adid: The access point (adapter/ agent) identified provided during registration of the SHAR-Q Adapter in VICINITY Neighbourhood Manager;
 * adid_password:  The password provided during the registration of the SHAR-Q Adapter in VICINITY Neighbourhood Manager.
The example of the connection setup is as follows:
```
var config = {
  gateway: {
    host: 'localhost',
    port: '8181',
    adid: 'e354cb68-xxxx-xxxx-xxxx-xxxxxxxxxxxx',
    adid_password: 'i73t826538136'
  }
...
  }
```

## Adapter simulator setup
The adapter simulator is configured by ```config.adapter``` object by the following properties:
 * port: port number on which adapter is running. Note, this should be the same as VICINITY Adapter one;
 * sign: enabling the signiture of the payload by the 'privateKey';
 * encrypt: enabling the encryption of the payload by the 'publicKey' of the service;
 * storage: directory where the adapter stores the results from the device/service registration;
 * privateKey: Key used for the signing the content of the messages;
 * publicKey: Key used for verification of the signiture of the signed messages by the service;

## Service configuration
The service is basically configured by ```publicKey``` and ```privateKey```. The ```publicKey``` is used to perform encryption of the content and ```privateKey``` is used to decrypt encrypted messages. Note, that public key used during verification of signed messages is configure by ```config.adapter.publicKey```.

# Run

### 1. Run Gateway api
To run the whole excercise we need to have atleast one installation of the SHAR-Q Gateway API running and accessible by the adapter simulator. Note, SHAR-Q Gateway API needs to be able reach the SHAR-Q Adapter on the configured port and IP as well.

Please follow the documentation of [Gateway API](http://vicinityh2020.github.io/vicinity-gateway-api).

### 2. Login the adapter

The adapter simulator need to login in SHAR-Q P2P network to perform device/service registration commands. Login will be done by simple following login command. The login command uses the configuration from the ```config.adapter```.

```
  node adapter-sim login
```
### 3. Register simulated devices
To make example working we need to have at least two devices to be registred in SHAR-Q P2P network. For this simple exercise two GPIO devices should enough. To register a device we need to run the registration command in adapter simulator.

```
  node adapter-sim register -i tds/dummygpio.json
  node adapter-sim register -i tds/dummygpio2.json
```

The result of the registration request will be stored in ```config.adapter.storage``` directory. This will be used by the adapter later during the login of the both device.


### 4. Login simulated device
To be able our device being reachable in SHAR-Q P2P network we need to login them in GW API.

For this purpose we will use the stored results of the registration commands from previous steps.
```
  node adapter-sim login -i storage/dummygpio-116ccf31-b8ec-4f11-8307-7ce507f7a413.json

  node adapter-sim login -i storage/dummygpio2-8cea6a8a-d071-4ef7-8232-b325d055ebec.json
```

### 5. Start adapter simulator
Now everything is setup, thus we can run the adapter simulator, that will simulate the ```dummygpio``` device.

```
  node adapter-sim serve -i tds/dummygpio.json
```

### 6. Reading the propety of DummyGpio
To read the ```onoff``` property from ```dummygpio``` simply runn the simple curl command:
```
curl -X GET \
http://localhost:8181/api/objects/116ccf31-b8ec-4f11-8307-7ce507f7a413/properties/onoff \
-H 'Cache-Control: no-cache' \
-H 'Postman-Token: c2f488c8-3b58-4778-aa36-8532d0d3f29e'
```


# Road map

## End-to-end encryption description in Thing description
There is currently opened discussion with W3C WoT, how the public key should be exchanged between peers (device/services) in SHAR-Q P2P network for the signing and encryption functionality.

## Constraints of the authenticated encryption in SHAR-Q Platform
The end-to-end encryption has the following constraints:
 * any headers, request URLs and URL parameters will not be end-to-end. However, this can be still protected by the SSL and TLS communication between GW API and Adapter.
